<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="etcd的使用, Zero">
    <meta name="description" content="一个穿梭在0和1的世界里的小白">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>etcd的使用 | Zero</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>





    <style type="text/css" lang="css"> #loading-container {
        position: fixed;
        top: 0;
        left: 0;
        min-height: 100vh;
        width: 100vw;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: #FFF;
        text-align: center; /* loader页面消失采用渐隐的方式*/
        -webkit-transition: opacity 1s ease;
        -moz-transition: opacity 1s ease;
        -o-transition: opacity 1s ease;
        transition: opacity 1s ease;
    }

    .loading-image {
        width: 120px;
        height: 50px;
        transform: translate(-50%);
    }

    .loading-image div:nth-child(2) {
        -webkit-animation: pacman-balls 1s linear 0s infinite;
        animation: pacman-balls 1s linear 0s infinite
    }

    .loading-image div:nth-child(3) {
        -webkit-animation: pacman-balls 1s linear .33s infinite;
        animation: pacman-balls 1s linear .33s infinite
    }

    .loading-image div:nth-child(4) {
        -webkit-animation: pacman-balls 1s linear .66s infinite;
        animation: pacman-balls 1s linear .66s infinite
    }

    .loading-image div:nth-child(5) {
        -webkit-animation: pacman-balls 1s linear .99s infinite;
        animation: pacman-balls 1s linear .99s infinite
    }

    .loading-image div:first-of-type {
        width: 0;
        height: 0;
        border: 25px solid #49b1f5;
        border-right-color: transparent;
        border-radius: 25px;
        -webkit-animation: rotate_pacman_half_up .5s 0s infinite;
        animation: rotate_pacman_half_up .5s 0s infinite;
    }

    .loading-image div:nth-child(2) {
        width: 0;
        height: 0;
        border: 25px solid #49b1f5;
        border-right-color: transparent;
        border-radius: 25px;
        -webkit-animation: rotate_pacman_half_down .5s 0s infinite;
        animation: rotate_pacman_half_down .5s 0s infinite;
        margin-top: -50px;
    }

    @-webkit-keyframes rotate_pacman_half_up {
        0% {
            transform: rotate(270deg)
        }
        50% {
            transform: rotate(1turn)
        }
        to {
            transform: rotate(270deg)
        }
    }

    @keyframes rotate_pacman_half_up {
        0% {
            transform: rotate(270deg)
        }
        50% {
            transform: rotate(1turn)
        }
        to {
            transform: rotate(270deg)
        }
    }

    @-webkit-keyframes rotate_pacman_half_down {
        0% {
            transform: rotate(90deg)
        }
        50% {
            transform: rotate(0deg)
        }
        to {
            transform: rotate(90deg)
        }
    }

    @keyframes rotate_pacman_half_down {
        0% {
            transform: rotate(90deg)
        }
        50% {
            transform: rotate(0deg)
        }
        to {
            transform: rotate(90deg)
        }
    }

    @-webkit-keyframes pacman-balls {
        75% {
            opacity: .7
        }
        to {
            transform: translate(-100px, -6.25px)
        }
    }

    @keyframes pacman-balls {
        75% {
            opacity: .7
        }
        to {
            transform: translate(-100px, -6.25px)
        }
    }

    .loading-image div:nth-child(3), .loading-image div:nth-child(4), .loading-image div:nth-child(5), .loading-image div:nth-child(6) {
        background-color: #49b1f5;
        width: 15px;
        height: 15px;
        border-radius: 100%;
        margin: 2px;
        width: 10px;
        height: 10px;
        position: absolute;
        transform: translateY(-6.25px);
        top: 25px;
        left: 100px;
    }

    .loading-text {
        margin-bottom: 20vh;
        text-align: center;
        color: #2c3e50;
        font-size: 2rem;
        box-sizing: border-box;
        padding: 0 10px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    @media only screen and (max-width: 500px) {
        .loading-text {
            font-size: 1.5rem;
        }
    }

    .fadeout {
        opacity: 0;
        filter: alpha(opacity=0);
    }

    /* logo出现动画 */
    @-webkit-keyframes fadeInDown {
        0% {
            opacity: 0;
            -webkit-transform: translate3d(0, -100%, 0);
            transform: translate3d(0, -100%, 0)
        }
        100% {
            opacity: 1;
            -webkit-transform: none;
            transform: none
        }
    }

    @keyframes fadeInDown {
        0% {
            opacity: 0;
            -webkit-transform: translate3d(0, -100%, 0);
        }
    } </style>
<script> (function () {
        const loaded = function () {
            setTimeout(function () {
                const loader = document.getElementById("loading-container");
                loader.className = "fadeout";//使用渐隐的方法淡出loading page // document.getElementById("body-wrap").style.display="flex";
     setTimeout(function(){ loader.style.display="none"; },2500); },1000);//强制显示loading page 1s
     }; loaded(); })() </script>



<body>


    <div id="loading-container"><p class="loading-text">嘘~ 正在从服务器偷取页面 . . . </p>
        <div class="loading-image">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>


<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Zero</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Zero</div>
        <div class="logo-desc">
            
            一个穿梭在0和1的世界里的小白
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>





<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/19.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">etcd的使用</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">
                                <span class="chip bg-color">云原生</span>
                            </a>
                        
                            <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                                <span class="chip bg-color">中间件</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Etcd/" class="post-category">
                                Etcd
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-02-11
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.2k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    23 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="etcd学习篇章"><a href="#etcd学习篇章" class="headerlink" title="etcd学习篇章"></a>etcd学习篇章</h1><h2 id="1-etcd是什么"><a href="#1-etcd是什么" class="headerlink" title="1. etcd是什么?"></a>1. etcd是什么?</h2><p><a target="_blank" rel="noopener" href="https://etcd.io/">官网原话:</a></p>
<blockquote>
<p> A distributed, reliable key-value store for the most critical data of a distributed system。</p>
</blockquote>
<p>翻译: <strong>分布式系统中最关键数据的分布式、可靠的键值结构存储。</strong></p>
<blockquote>
<p><strong>etcd</strong>是由Go语言编写的一种<strong>高度一致性</strong>的分布式键值结构存储系统。它可以以一种<strong>非常可靠</strong>的方式来存储一些可能会被分布式系统或者及机器集群所要访问的重要数据。它在网络分区期间优雅地处理领导选举，并且可以容忍机器故障,哪怕是leader节点故障。</p>
</blockquote>
<h2 id="2-etcd的特点"><a href="#2-etcd的特点" class="headerlink" title="2. etcd的特点"></a>2. etcd的特点</h2><ol>
<li>基于标准化的HTTP协议进行操作,使用json数据格式进行交互。</li>
<li>数据存储在分层组织的目录中,如同标准文件系统一样。</li>
<li>支持数据监听。</li>
<li>支持ssl证书访问。</li>
<li>每个实例以每秒 1000 次写入为基准。</li>
<li>支持数据有效期。</li>
<li>通过 Raft 协议正确分发。</li>
</ol>
<h2 id="3-etcd使用场景"><a href="#3-etcd使用场景" class="headerlink" title="3. etcd使用场景"></a>3. etcd使用场景</h2><p><strong>etcd</strong>通常用来管理一些<strong>控制数据</strong>和<strong>业务数据</strong>。对于<strong>业务数据</strong>只推荐那些<strong>数据量较小,但是经常执行更新操作,并且要求强一致性的数据</strong>。</p>
<p>常见的使用场景有如下几种:</p>
<ul>
<li>服务注册与发现</li>
<li>服务配置中心</li>
<li>分布式锁</li>
<li>分布式队列</li>
<li>分布式调度协调</li>
<li>等等…</li>
</ul>
<h2 id="4-etcd与zk的区别"><a href="#4-etcd与zk的区别" class="headerlink" title="4. etcd与zk的区别"></a>4. etcd与zk的区别</h2><p>就目前来看etcd与zookeeper有着很大的相似之处,那么为什么有了zk还要etcd呢？换句话说etcd比zk有哪方面的优势与区别呢? 有如下几点:</p>
<ol>
<li>与zk相比 etcd的安装、部署和使用更加简单容易。</li>
<li>etcd在<strong>数据一致性</strong>方面更加可靠,zk虽然也是主打<strong>一致性</strong>,但是并没有etcd达到极致。</li>
<li>在服务发现的实现上,zk使用的是<strong>临时节点</strong>,而<strong>临时节点</strong>存在着许多问题。而etcd使用的是<strong>节点租约(Lease)</strong>,并且支持Group(多key)。</li>
<li>etcd在<strong>Watch</strong>机制上更加强大稳定,它可以做到长久监听,而zk的<strong>Watch</strong>机制触发一次后就会失效。</li>
<li>etcd支持<strong>MVCC(多版本并发控制-无锁机制)</strong>,因为有协同系统需要无锁操作。</li>
<li>etcd支持的数据存储规模更大,支持上百万至千万的KV数据存储。</li>
</ol>
<p>目前etcd是<strong>Kubernetes</strong>的首要数据存储组件,在整个云原生体系中都有着极高的地位。在Go领域的各大分布式框架中,etcd更是首要人物,可谓是上天的宠儿~</p>
<h2 id="5-etcd的安装"><a href="#5-etcd的安装" class="headerlink" title="5. etcd的安装"></a>5. etcd的安装</h2><h3 id="1-单节点安装"><a href="#1-单节点安装" class="headerlink" title="1. 单节点安装"></a>1. 单节点安装</h3><p><a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases/">下载地址</a></p>
<p>这里选用的版本为 <a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases/download/v3.5.7/etcd-v3.5.7-linux-arm64.tar.gz">3.5.7</a></p>
<p>下载完后直接解压即可</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">tar -zxvf etcd-v3.5.7-linux-arm64.tar.gz<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后就可以直接运行</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">cd etcd-v3.5.7-linux-arm64
./etcd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>一个etcd就简简单单的安装完成了。</p>
<p>我使用的mac系统,似乎直接安装系统不兼容,所以进行源码安装。</p>
<p><strong>源码编译安装</strong></p>
<p>注意:源码安装需要Go的开发环境哦~</p>
<p>首先克隆源码仓库到本地</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">git clone -b v3.5.7 https://github.com/etcd-io/etcd.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后进入仓库</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">cd etcd-3.5.7 <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>进行编译</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">./build.sh<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>然后慢慢等待即可.</p>
<p>直到出现如下界面:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">....
....
stderr: go: downloading github.com/urfave/cli v1.22.4
SUCCESS: etcd_build (GOARCH=)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译好的可执行文件在目录的<code>bin</code>文件夹</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">cd bin
ls 
etcd	etcdctl	etcdutl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>查看etcd的版本</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% ./etcd --version
etcd Version: 3.5.7
Git SHA: GitNotFound
Go Version: go1.18.1
Go OS/Arch: darwin/arm64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>运行</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">./etcd<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果有需要也可以将该<code>bin</code>目录配置到环境变量中</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">export PATH="$PATH:*****/etcd-3.5.7/bin"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>当etcd启动后,可以通过<code>http://localhost:2379</code>来访问可视化界面。</p>
<h3 id="2-单机集群部署"><a href="#2-单机集群部署" class="headerlink" title="2. 单机集群部署"></a>2. 单机集群部署</h3><p><strong>etcd server默认使用2380端口来监听集群中其他的节点的请求</strong>,如果一台机器上启动多个etcd节点,那么端口就会产生冲突.所以如果要在一台机器上搭建etcd集群,那么端口一定要注意交错开。</p>
<p>下面我们创建一个etcd集群,3个节点(一个集群至少3个节点),通过进程管理工具goreman来快速创建、停止etcd集群。</p>
<p><strong>安装goreman</strong></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">go install github.com/mattn/goreman@latest

go: downloading github.com/mattn/goreman v0.3.13
go: downloading golang.org/x/sys v0.0.0-20220708085239-5a0f0661e09d
go: downloading github.com/joho/godotenv v1.4.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后创建etcd集群配置文件:</p>
<p>单个节点配置格式:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">节点序号: etcd --name 节点名称 
				--listen-client-urls 客户端连接端口 
				--advertise-client-urls 如果有多个客户端连接的情况下推荐使用的连接 
				--listen-peer-urls 节点之间互相通信选举的端口
				--initial-cluster-token 集群的token
				--initial-cluster-state 初始化时集群的状态
				--initial-cluster 所有的节点(节点名称:节点通信选举端口)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>完整配置文件内容:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">etcd1: etcd --name node1 --listen-client-urls http://127.0.0.1:12379 --advertise-client-urls http://127.0.0.1:12379 --listen-peer-urls http://127.0.0.1:12380 --initial-cluster-token etcd-cluster-token --initial-cluster-state new --initial-cluster 'node1=http://127.0.0.1:12380,node2=http://127.0.0.1:22380,node3=http://127.0.0.1:32380'

etcd2: etcd --name node2 --listen-client-urls http://127.0.0.1:22379 --advertise-client-urls http://127.0.0.1:22379 --listen-peer-urls http://127.0.0.1:22380 --initial-cluster-token etcd-cluster-token --initial-cluster-state new --initial-cluster 'node1=http://127.0.0.1:12380,node2=http://127.0.0.1:22380,node3=http://127.0.0.1:32380'

etcd3: etcd --name node3 --listen-client-urls http://127.0.0.1:32379 --advertise-client-urls http://127.0.0.1:32379 --listen-peer-urls http://127.0.0.1:32380 --initial-cluster-token etcd-cluster-token --initial-cluster-state new --initial-cluster 'node1=http://127.0.0.1:12380,node2=http://127.0.0.1:22380,node3=http://127.0.0.1:32380'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>参数详细说明</strong></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>–name</td>
<td>本节点的名称</td>
</tr>
<tr>
<td>–listen-client-urls</td>
<td>本节点客户端可以连接的端口(可以有多个)(默认为:<a target="_blank" rel="noopener" href="http://locahost:2379/">http://locahost:2379</a>)</td>
</tr>
<tr>
<td>–advertise-client-urls</td>
<td>推荐使用的客户端连接端口(如果有多个的情况下)</td>
</tr>
<tr>
<td>–listen-peer-urls</td>
<td>与其他服务端节点通信选举的端口(可以有多个)(默认为:<a target="_blank" rel="noopener" href="http://locahost:2380/">http://locahost:2380</a>)</td>
</tr>
<tr>
<td>–initial-advertise-peer-urls</td>
<td>推荐使用的服务端节点通信端口</td>
</tr>
<tr>
<td>–initial-cluster-token</td>
<td></td>
</tr>
<tr>
<td>–initial-cluster-state</td>
<td>初始化集群的状态,’new’表示新建的集群,’existing’表示加入已存在的集群</td>
</tr>
<tr>
<td>–initial-cluster</td>
<td>所有要加入集群的节点的通信地址。启动时,集群根据该配置找到所有节点。<br>‘node1name:ip:通信port,node2name:ip:通信port,…..’</td>
</tr>
</tbody></table>
<p>接下来就可以通过goreman读取该配置文件,启动etcd集群:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">goreman -f ./cluster-profile start

03:34:52 etcd2 | Starting etcd2 on port 5100
03:34:52 etcd1 | Starting etcd1 on port 5000
03:34:52 etcd3 | Starting etcd3 on port 5200
......<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>启动完成以后,我们访问任意一个节点,都会获取集群所有节点的信息:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl --endpoints=localhost:12379 member list
6ad1063bfbf8109a, started, node1, http://127.0.0.1:12380, http://127.0.0.1:12379, false
b97e3c6361bc17b8, started, node2, http://127.0.0.1:22380, http://127.0.0.1:22379, false
ed32a2a50a061fea, started, node3, http://127.0.0.1:32380, http://127.0.0.1:32379, false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>单独关闭某个节点</strong></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">goreman run stop etcd2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>单独启动某个节点</strong></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">goreman run start etcd2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>单独重启某个节点</strong></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">goreman run restart etcd2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>向其中一个节点写入数据</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl put name 张三 --endpoints=localhost:22379
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后从另一个节点中读取</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl get name --endpoints=localhost:32379  
name
张三<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>显然是可以获取到的.</p>
<h2 id="6-基础数据操作"><a href="#6-基础数据操作" class="headerlink" title="6. 基础数据操作"></a>6. 基础数据操作</h2><p>etcd的命令行工具提供了大量命令对数据进行操作,接下来我们来一一使用并且解释其作用.</p>
<h3 id="help"><a href="#help" class="headerlink" title="help"></a>help</h3><p>获取命令帮助。</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">zero@Zero ~ % etcdctl help
NAME:
	etcdctl - A simple command line client for etcd3.

USAGE:
	etcdctl [flags]

VERSION:
	3.5.7

API VERSION:
	3.5


COMMANDS:
	alarm disarm		Disarms all alarms
	alarm list		Lists all alarms
	auth disable		Disables authentication
	auth enable		Enables authentication
	auth status		Returns authentication status
	check datascale		Check the memory usage of holding data for different workloads on a given server endpoint.
	check perf		Check the performance of the etcd cluster
	compaction		Compacts the event history in etcd
	defrag			Defragments the storage of the etcd members with given endpoints
	del			Removes the specified key or range of keys [key, range_end)
	elect			Observes and participates in leader election
	endpoint hashkv		Prints the KV history hash for each endpoint in --endpoints
	endpoint health		Checks the healthiness of endpoints specified in `--endpoints` flag
	endpoint status		Prints out the status of endpoints specified in `--endpoints` flag
	get			Gets the key or a range of keys
	help			Help about any command
	lease grant		Creates leases
	lease keep-alive	Keeps leases alive (renew)
	lease list		List all active leases
	lease revoke		Revokes leases
	lease timetolive	Get lease information
	lock			Acquires a named lock
	make-mirror		Makes a mirror at the destination etcd cluster
	member add		Adds a member into the cluster
	member list		Lists all members in the cluster
	member promote		Promotes a non-voting member in the cluster
	member remove		Removes a member from the cluster
	member update		Updates a member in the cluster
	move-leader		Transfers leadership to another etcd cluster member.
	put			Puts the given key into the store
	role add		Adds a new role
	role delete		Deletes a role
	role get		Gets detailed information of a role
	role grant-permission	Grants a key to a role
	role list		Lists all roles
	role revoke-permission	Revokes a key from a role
	snapshot restore	Restores an etcd member snapshot to an etcd directory
	snapshot save		Stores an etcd node backend snapshot to a given file
	snapshot status		[deprecated] Gets backend snapshot status of a given file
	txn			Txn processes all the requests in one transaction
	user add		Adds a new user
	user delete		Deletes a user
	user get		Gets detailed information of a user
	user grant-role		Grants a role to a user
	user list		Lists all users
	user passwd		Changes password of user
	user revoke-role	Revokes a role from a user
	version			Prints the version of etcdctl
	watch			Watches events stream on keys or prefixes

OPTIONS:
      --cacert=""				verify certificates of TLS-enabled secure servers using this CA bundle
      --cert=""					identify secure client using this TLS certificate file
      --command-timeout=5s			timeout for short running command (excluding dial timeout)
      --debug[=false]				enable client-side debug logging
      --dial-timeout=2s				dial timeout for client connections
  -d, --discovery-srv=""			domain name to query for SRV records describing cluster endpoints
      --discovery-srv-name=""			service name to query when using DNS discovery
      --endpoints=[127.0.0.1:2379]		gRPC endpoints
  -h, --help[=false]				help for etcdctl
      --hex[=false]				print byte strings as hex encoded strings
      --insecure-discovery[=true]		accept insecure SRV records describing cluster endpoints
      --insecure-skip-tls-verify[=false]	skip server certificate verification (CAUTION: this option should be enabled only for testing purposes)
      --insecure-transport[=true]		disable transport security for client connections
      --keepalive-time=2s			keepalive time for client connections
      --keepalive-timeout=6s			keepalive timeout for client connections
      --key=""					identify secure client using this TLS key file
      --password=""				password for authentication (if this option is used, --user option shouldn't include password)
      --user=""					username[:password] for authentication (prompt if password is not supplied)
  -w, --write-out="simple"			set the output format (fields, json, protobuf, simple, table)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="设置K-V数据"><a href="#设置K-V数据" class="headerlink" title="设置K-V数据"></a>设置K-V数据</h3><p>设置数据</p>
<p>命令格式:<code>etcdctl put key value</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl put name 张三
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="读取K-V数据"><a href="#读取K-V数据" class="headerlink" title="读取K-V数据"></a>读取K-V数据</h3><p><strong>根据Key获取对应的值数据</strong></p>
<p>命令格式: <code>etcdctl get key</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl get name
name
张三<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>读取指定节点的数据</strong></p>
<p>命令格式: <code>etcdctl get key --endpoints=节点ip:端口</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl get name --endpoints=localhost:2379
name
张三<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>获取数据,以十六进制格式返回</strong></p>
<p>使用<code>--hex</code>参数表示以十六进制格式返回</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">etcdctl get name --hex

\x6e\x61\x6d\x65
\xe5\xbc\xa0\xe4\xb8\x89<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>获取两个key范围之间的所有数据</strong></p>
<p>命令格式: <code>etcdctl get key1 key2</code></p>
<p>返回key1到key2区间的所有key数据(包含key1,但不包含key2的数据)</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl put /service/user1 张三
OK
% etcdctl put /service/user2 李四
OK
% etcdctl put /service/user3 王五
OK
% etcdctl put /service/user4 赵六
OK


% etcdctl get /service/user1 /service/user4
/service/user1
张三
/service/user2
李四
/service/user3
王五<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>根据key的前缀匹配获取数据</strong></p>
<p>通过<code>--prefix</code>参数匹配前缀获取</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl get --prefix /service
/service/user1
张三
/service/user2
李四
/service/user3
王五
/service/user4
赵六<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过<code>--limit number</code>参数限流返回的结果数量</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl get --prefix --limit 1 /service
/service/user1
张三<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>根据key的字典顺序大小获取数据</strong></p>
<p>如下: 获取顺序大于或等于<code>/service/user2</code>的数据</p>
<p>通过<code>--from-key</code>参数</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl get --from-key /service/user2
/service/user2
李四
/service/user3
王五
/service/user4
赵六<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>获取一个数据的详细信息</strong></p>
<p>如下,我们针对<code>/item/user</code>进行了多次修改,在数据内部,会有一个<code>version</code>记录数据被修改的次数.</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl put /item/user Hello
OK
zero@Zero ~ % etcdctl put /item/user World
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>获取数据的详细信息</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl get /item/user -w json <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><code>-w json</code>表示以json格式返回结果,会获取到如下结果:</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">{</span><span class="token property">"header"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"cluster_id"</span><span class="token operator">:</span><span class="token number">14841639068965178418</span><span class="token punctuation">,</span><span class="token property">"member_id"</span><span class="token operator">:</span><span class="token number">10276657743932975437</span><span class="token punctuation">,</span><span class="token property">"revision"</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token property">"raft_term"</span><span class="token operator">:</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token property">"kvs"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token property">"key"</span><span class="token operator">:</span><span class="token string">"L2l0ZW0vdXNlcg=="</span><span class="token punctuation">,</span><span class="token property">"create_revision"</span><span class="token operator">:</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token property">"mod_revision"</span><span class="token operator">:</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token property">"version"</span><span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token property">"value"</span><span class="token operator">:</span><span class="token string">"V29ybGQ="</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token property">"count"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>参数解释如下:</p>
<p>cluster_id: 当前访问的etcd的集群ID</p>
<p>member_id: 当前访问的etcd的节点ID</p>
<p>revision: 全局数据的控制版本号,对任何一个key进行修改后,该数值都会+1。默认初始化为1,因为修改数据版本从2开始。</p>
<p>raft_term： etcd当前raft主节点任期号。</p>
<p>create_revision：该key创建时,全局数据的版本号的值。</p>
<p>mod_revision：该key最后一次修改时,全局数据的版本号的值。</p>
<p>version：该key的数据版本号,创建时为1,对key进行put操作会自增1,如果删除后重新创建又会从1开始。</p>
<p><strong>获取数据的旧版本值</strong></p>
<p>通过<code>--rev=n</code> 获取key第n个版本的值,注意: 这个<code>n</code>是全局数据版本号,而不是该key数据版本号哦.</p>
<p>如获取<code>/item/user</code>初始化时的值,创建<code>/item/user</code>时,全局版本号为10,所以要通过<code>--rev=10</code>参数获取初始化值</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">etcdctl get --rev=10 /item/user<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果要获取更往前版本的值,只需要把版本号往前写即可,前提是有这些版本。</p>
<h3 id="删除K-V数据"><a href="#删除K-V数据" class="headerlink" title="删除K-V数据"></a>删除K-V数据</h3><p>删除数据</p>
<p>删除单个数据:<code>etcdctl del key</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl del name
1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>范围删除: <code>etcdctl del key1 key2</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">etcdctl del node1 node2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>根据key前缀批量删除数据</strong></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">etcdctl del --prefix /service<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><strong>删除时并且返回数据</strong></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl del name --prev-kv
1
name
张三<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-Watch监听"><a href="#7-Watch监听" class="headerlink" title="7. Watch监听"></a>7. Watch监听</h2><p><code>Watch</code>机制能够监听某一个key数据的操作,并且只要连接不断,就会持续监听。</p>
<p>如下,我们监听key为<code>/user</code>的数据:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl watch /user
# ...进入阻塞状态<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>然后我们再次打开一个新的终端</p>
<p>这个时候,是没有这个key的,接下来我们来创建这个key:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl put /user root  
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>创建完成,这个时候监听终端则会发生如下变化:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl watch /user

PUT
/user
root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>PUT</code> 表示监听到的事件为新增或者修改.</p>
<p><code>/user</code>表示监听的Key.</p>
<p><code>root</code>表示新增或者修改的值.</p>
<p>然后我们还可以再次修改:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl put /user newRoot
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl watch /user
PUT
/user
root
#-----------------
PUT
/user
newRoot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>只要终端连接没有断开,那么这监听就是持久性的.</p>
<p>当然它也可以监听到删除事件:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl del /user
1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl watch /user
...
DELETE
/user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="8-Lease租约"><a href="#8-Lease租约" class="headerlink" title="8. Lease租约"></a>8. Lease租约</h2><p>简单来说就是指定一个key的有效时间,超过了这个时间后,key将会失效.类似于Redis中的ttl。</p>
<p>租约和Key是隔离开的,其使用方式为:创建一个租约,然后绑定到key中。</p>
<h3 id="1-创建租约"><a href="#1-创建租约" class="headerlink" title="1. 创建租约"></a>1. 创建租约</h3><p>命令格式: <code>etcdctl lease grant &lt;number&gt;</code> 时间单位为秒.</p>
<p>如下命令,创建一个有效期为10s的租约:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl lease grant 10 
lease 694d8640f7eb832e granted with TTL(10s)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这里会返回一个租约的标识,使用该租约只要通过该标识即可。</p>
<h3 id="2-查看租约信息"><a href="#2-查看租约信息" class="headerlink" title="2. 查看租约信息"></a>2. 查看租约信息</h3><p>命令格式: <code>etcdctl lease timetolive &lt;lease_id&gt;</code></p>
<p>查看租约是否已经过期</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl lease grant 50                   
lease 694d8640f7eb8331 granted with TTL(50s)

% etcdctl lease timetolive 694d8640f7eb8331
lease 694d8640f7eb8331 granted with TTL(50s), remaining(37s)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到,该租约目前还没有过期,一共时长为50s,当前还剩余37s。</p>
<p>当时间过期后,再次查询:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl lease timetolive 694d8640f7eb8331
lease 694d8640f7eb8331 already expired<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>显示<code>694d8640f7eb8331</code>租约已经过期。</p>
<p>也可以通过<code>--keys</code>查看多个租约:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">etcdctl lease timetolive --keys &lt;ids...&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<h3 id="3-查看有效的租约列表"><a href="#3-查看有效的租约列表" class="headerlink" title="3. 查看有效的租约列表"></a>3. 查看有效的租约列表</h3><p>命令格式: <code>etcdctl lease list</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl lease list    
found 1 leases
694d8640f7eb8334<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>可以看到,目前只有一个有效的租约。</p>
<h3 id="4-使用租约"><a href="#4-使用租约" class="headerlink" title="4. 使用租约"></a>4. 使用租约</h3><p>在创建key时,通过<code>--lease=&lt;lease_id&gt;</code> 来指定租约.</p>
<p>如下,创建一个有效期为100s的租约,并且使用在key上.</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl lease grant 100
lease 694d8640f7eb833d granted with TTL(100s)

% etcdctl put --lease=694d8640f7eb833d /username 张三
OK

% etcdctl get /username -w fields
"ClusterID" : 14841639068965178418
"MemberID" : 10276657743932975437
"Revision" : 18
"RaftTerm" : 3
"Key" : "/username"
"CreateRevision" : 18
"ModRevision" : 18
"Version" : 1
"Value" : "张三"
"Lease" : 7587868560784589629
"More" : false
"Count" : 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当租约过期后,该key也会消除掉。</p>
<p>等待时间过后我们再次查询该key:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl get /username     
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>没有看到任何数据。</p>
<h3 id="5-撤销租约"><a href="#5-撤销租约" class="headerlink" title="5. 撤销租约"></a>5. 撤销租约</h3><p>命令格式: <code>etcdctl lease revoke &lt;lease_id&gt;</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">etcdctl lease revoke 694d8640f7eb8337                 
lease 694d8640f7eb8337 revoked<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>注意:<strong>如果租约被撤销了,那么正在使用该租约的所有key，都会被删除掉</strong>:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 创建租约
etcdctl lease grant 300                             
lease 694d8640f7eb834b granted with TTL(300s)

# 使用租约
% etcdctl put --lease=694d8640f7eb834b /user/admin zhangsan           
OK

# 查看数据
% etcdctl get /user/admin
/user/admin
zhangsan

# 撤销租约
% etcdctl lease revoke 694d8640f7eb834b
lease 694d8640f7eb834b revoked

# 再次查看数据,发现数据也不存在了
% etcdctl get /user/admin  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h3 id="5-刷新租约"><a href="#5-刷新租约" class="headerlink" title="5. 刷新租约"></a>5. 刷新租约</h3><p>命令格式:<code>etcdctl lease keep-alive &lt;lease_id&gt;</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl lease keep-alive 694d8640f7eb8352
lease 694d8640f7eb8352 keepalived with TTL(100)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>比如一个租约为100s,现在这个租约马上到期了,我们只需要刷新一下该租约,租约的有效期就会重新刷新为100s。</p>
<p><strong>在分布式锁的实现上,使用etcd会有很大的优势,因为etcd的租约可以同时被多个key所绑定,如果租约进行续约了,会同时影响到所有被绑定的key。</strong></p>
<h2 id="9-权限管理"><a href="#9-权限管理" class="headerlink" title="9. 权限管理"></a>9. 权限管理</h2><p>etcd默认是关闭权限控制的,也就是任何连接都可以进行操作。</p>
<h3 id="1-权限状态"><a href="#1-权限状态" class="headerlink" title="1. 权限状态"></a>1. 权限状态</h3><p><code>etcdctl auth status</code>: 查看权限管理状态</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl auth status
Authentication Status: false
AuthRevision: 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>当前状态为<code>false</code>。未开启。</p>
<h3 id="2-开启权限管理"><a href="#2-开启权限管理" class="headerlink" title="2. 开启权限管理"></a>2. 开启权限管理</h3><p><code>etcdctl auth enable</code>: 开启etcd的权利管理</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl auth enable
....
Error: etcdserver: root user does not exist<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>要想开启权利管理,首先必须要有一个<code>root</code>用户.接下来我们创建一个root用户:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"># 添加一个root用户
% etcdctl user add root 
# 输入密码
Password of root: 
# 确认密码
Type password of root again for confirmation: 
User root created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里的密码和用户保持一致,为<code>root</code>。</p>
<p>然后再次打开权限管理:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl auth enable  
{"level":"warn","ts":"2023-02-12T23:18:19.907+0800","logger":"etcd-client","caller":"v3@v3.5.7/retry_interceptor.go:62","msg":"retrying of unary invoker failed","target":"etcd-endpoints://0x1400019c000/127.0.0.1:2379","attempt":0,"error":"rpc error: code = FailedPrecondition desc = etcdserver: root user does not have root role"}
Authentication Enabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>表示打开成功.这个时候你再对etcd做任何操作的时候,都需要通过权限认证.否则无法执行,错误操作如下:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl put /test/123 data1 
{"level":"warn","ts":"2023-02-12T23:23:14.711+0800","logger":"etcd-client","caller":"v3@v3.5.7/retry_interceptor.go:62","msg":"retrying of unary invoker failed","target":"etcd-endpoints://0x14000228000/127.0.0.1:2379","attempt":0,"error":"rpc error: code = InvalidArgument desc = etcdserver: user name is empty"}
Error: etcdserver: user name is empty<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这个时候必须要使用拥有相关权限的用户才能执行操作:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl put /test/123 data1 --user=root
# 输入root用户的密码
Password: 
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-关闭权限管理"><a href="#3-关闭权限管理" class="headerlink" title="3. 关闭权限管理"></a>3. 关闭权限管理</h3><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl auth disable --user=root
Password: 
Authentication Disabled<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="10-用户管理"><a href="#10-用户管理" class="headerlink" title="10.用户管理"></a>10.用户管理</h2><h3 id="1-创建用户"><a href="#1-创建用户" class="headerlink" title="1. 创建用户"></a>1. 创建用户</h3><p>命令格式: <code>etcdctl user add &lt;用户名&gt;</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl user add test_user
# 输入密码和确认密码
Password of test_user: 
Type password of test_user again for confirmation: 
User test_user created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-删除用户"><a href="#2-删除用户" class="headerlink" title="2. 删除用户"></a>2. 删除用户</h3><p>命令格式: <code>etcdctl user del &lt;用户名&gt;</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl user del test_user
User test_user deleted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="3-修改用户密码"><a href="#3-修改用户密码" class="headerlink" title="3. 修改用户密码"></a>3. 修改用户密码</h3><p>命令格式: <code>etcdctl user passwd &lt;要修改的用户名&gt;</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl user passwd test_user
Password of test_user: 
Type password of test_user again for confirmation: 
Password updated<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-查看用户列表"><a href="#4-查看用户列表" class="headerlink" title="4. 查看用户列表"></a>4. 查看用户列表</h3><pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl user list
root
test_user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="5-查看用户的角色"><a href="#5-查看用户的角色" class="headerlink" title="5. 查看用户的角色"></a>5. 查看用户的角色</h3><p>命令格式: <code>etcdctl user get &lt;用户名&gt;</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl user get root
User: root
Roles: root<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="11-角色管理"><a href="#11-角色管理" class="headerlink" title="11.角色管理"></a>11.角色管理</h2><h3 id="1-创建角色"><a href="#1-创建角色" class="headerlink" title="1. 创建角色"></a>1. 创建角色</h3><p>命令格式: <code>etcdctl role add &lt;角色名&gt;</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl role add test_user_role
Role test_user_role created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="2-设置角色权限"><a href="#2-设置角色权限" class="headerlink" title="2. 设置角色权限"></a>2. 设置角色权限</h3><p>命令格式: <code>etcdctl role grant-permission [角色名] [read|write|readwrite] [key]</code></p>
<p>如下命令: 为<code>test_user_role</code>角色授予对<code>/user</code>数据的<code>readwrite</code>(读写权限).</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl role grant-permission test_user_role readwrite /user
Role test_user_role updated<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="3-撤销角色权限"><a href="#3-撤销角色权限" class="headerlink" title="3. 撤销角色权限"></a>3. 撤销角色权限</h3><p>命令格式: <code>etcdctl role revoke-permission [角色名] [key]</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl role revoke-permission test_user_role /user
Permission of key /user is revoked from role test_user_role<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="4-删除角色"><a href="#4-删除角色" class="headerlink" title="4. 删除角色"></a>4. 删除角色</h3><p>命令格式: <code>etcdctl role del [角色名]</code></p>
<h3 id="5-查询角色列表"><a href="#5-查询角色列表" class="headerlink" title="5. 查询角色列表"></a>5. 查询角色列表</h3><p>命令格式: <code>etcdctl role list</code></p>
<h3 id="6-角色与用户绑定"><a href="#6-角色与用户绑定" class="headerlink" title="6. 角色与用户绑定"></a>6. 角色与用户绑定</h3><p>命令格式: <code>etcdctl user grant-role [用户名] [角色名]</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">% etcdctl user grant-role test_user test_user_role
Role test_user_role is granted to user test_user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="7-角色与用户解除绑定"><a href="#7-角色与用户解除绑定" class="headerlink" title="7. 角色与用户解除绑定"></a>7. 角色与用户解除绑定</h3><p>命令格式: <code>etcdctl user revoke-role [用户名] [角色名]</code></p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh"> % etcdctl user revoke-role test_user test_user_role
Role test_user_role is revoked from user test_user<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>集群环境下管理</strong></p>
<p>如果时在集群环境下执行权限相关的命令式,则需要加上<code>--endpoints=ip1:12379,ip2:12379,ip3:12379</code></p>
<p>如开启集群环境权限管理:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">etcdctl auth enable --endpoints=localhost:12379,localhost:22379,localhost:32379<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>添加用户</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">etcdctl user add test --endpoints=localhost:12379,localhost:22379,localhost:32379<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>集群环境下并且开启了权限管理,添加数据:</p>
<pre class="line-numbers language-sh" data-language="sh"><code class="language-sh">etcdctl put /test/data --endpoints=localhost:12379,localhost:22379,localhost:32379 --user=root<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="12-串行读与线性读"><a href="#12-串行读与线性读" class="headerlink" title="12.串行读与线性读"></a>12.串行读与线性读</h2><h3 id="1-串行读"><a href="#1-串行读" class="headerlink" title="1. 串行读"></a>1. 串行读</h3><p>串行读是直接读取当前节点状态机的数据,不需要Raft协议与集群进行交互,具有低延迟、高吞吐量的特点,适合对数据一致性要求不高的场景。</p>
<h3 id="2-线性读"><a href="#2-线性读" class="headerlink" title="2. 线性读"></a>2. 线性读</h3><p><strong>etcd默认的就是线性读</strong>,需要经过Raft协议,读取的是所有集群节点一致的数据,因此在延迟和吞吐量上略差于串行读。适合对数据一致性要求较高的场景。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Zero</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://zlx2019.github.io/2023/02/11/etcd%E7%9A%84%E4%BD%BF%E7%94%A8/">https://zlx2019.github.io/2023/02/11/etcd%E7%9A%84%E4%BD%BF%E7%94%A8/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Zero</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/">
                                    <span class="chip bg-color">云原生</span>
                                </a>
                            
                                <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/">
                                    <span class="chip bg-color">中间件</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2023/02/11/Go%E3%80%90%E5%8D%81%E5%9B%9B%E3%80%91%E4%BC%98%E9%9B%85%E5%85%B3%E9%97%ADhttp%E6%9C%8D%E5%8A%A1/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Go【十四】优雅关闭http服务">
                        
                        <span class="card-title">Go【十四】优雅关闭http服务</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-02-11
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Go/" class="post-category">
                                    Go
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Go%E5%9F%BA%E7%A1%80/">
                        <span class="chip bg-color">Go基础</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/02/01/SpringBoot3%E3%80%90%E4%B8%80%E3%80%91Native/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="SpringBoot3【一】Native">
                        
                        <span class="card-title">SpringBoot3【一】Native</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-02-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SpringBoot/" class="post-category">
                                    SpringBoot
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/SpringBoot3-%E5%BE%AE%E6%9C%8D%E5%8A%A1-%E4%BA%91%E5%8E%9F%E7%94%9F/">
                        <span class="chip bg-color">SpringBoot3 微服务 云原生</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




<footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="41220530"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2023</span>
            
            <span id="year">2021</span>
            <a href="/about" target="_blank">Zero</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">219.8k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2021";
                    var startMonth = "4";
                    var startDate = "10";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/zlx2019" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1143967454@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1143967454" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1143967454" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


<script src="/libs/materialize/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Baidu Analytics -->

<!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>


    <script src="/libs/others/clicklove.js" async="async"></script>


    <script async src="/libs/others/busuanzi.pure.mini.js"></script>










    
    <script type="text/javascript" size="150" alpha='0.6'
            zIndex="-1" src="/libs/background/ribbon-refresh.min.js"
            async="async"></script>



    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js"
            async="async"></script>



    <script src="/libs/instantpage/instantpage.js" type="module"></script>


<!-- 樱花特效 -->


<!--鼠标移动雪花特效-->


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
